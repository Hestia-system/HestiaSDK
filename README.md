# HestiaSDK

Structured IoT runtime for ESP32 (C3/C6/S3) providing MQTT/HA bridges, metadata-driven configuration, provisioning, and deterministic Wi-Fi/MQTT state machines.

---

## Overview

**HestiaSDK** is a modular framework designed to build robust ESP32 IoT firmware integrating:

- **HestiaCore** – high-level runtime orchestrator  
- **HAIoTBridge** – MQTT / Home Assistant dynamic entity layer  
- **HestiaConfig (R2)** – metadata-driven configuration + NVS persistence  
- **Provisioning** – captive-portal Wi-Fi AP with autogenerated form  
- **HestiaNetSDK** – non-blocking Wi-Fi Guard & MQTT Guard  
- **HardwareInit** – minimal startup & ESP-IDF watchdog  
- **HestiaTools** – generic timers, ISO timestamps, JSON logs  

The SDK cleanly separates:

- **Firmware parameters** → defined statically in `DeviceParams.h`  
- **User provisioning parameters** → handled via the provisioning portal, stored in NVS  

---

# Features

## 1. HestiaCore — Runtime Orchestrator
- Instantiates all entities defined in `bridge_config[]`  
- Coordinates the **Wi-Fi → MQTT → Home Assistant Discovery** sequence  
- Manages MQTT subscriptions and dispatch  
- Provides online state indicators (`comm_state_ok`, `newSeqComm`)  
- Centralizes MQTT publication and HA logging  

---

## 2. HAIoTBridge — Home Assistant Entity Layer
- Supported behaviors: **CONTROL**, **INDICATOR**, **BUTTON**, **ENTITIES**  
- Automatic NVS storage for CONTROL entities  
- Normalization of boolean, integer, and float formats (resolution-based)  
- Change detection with automatic publish  
- Directional MQTT routing (`topicTo`, `topicFrom`)  

---

## 3. HestiaConfig R2 — Parameter System

- Parses PROGMEM JSON schema from `DeviceParams.h`  
- Full metadata:  
  - type  
  - pattern  
  - min/max  
  - minLen/maxLen  
  - decimals  
  - default  
- NVS persistence for provisioning parameters  
- R2 validation: **only parameters marked `critical`**  
- Unified API:

String ssid = HestiaConfig::getParam("wifi_ssid");
HestiaParam* p = HestiaConfig::getParamObj("mqtt_port");

---

## 4. Provisioning — Captive Portal AP

- ESP32 SoftAP named after `device_id`  
- Dynamic HTML form generated directly from the schema JSON  
- Client-side validation (HTML5 patterns, min/max, required fields)  
- `/save` and `/forceSave` submission modes  
- Immediate NVS persistence for all submitted values  
- Automatic reboot after successful save  

---

## 5. HestiaNetSDK — Wi-Fi & MQTT Guards

- Fully **non-blocking** design for all networking flows  
- **Wi-Fi Guard** with driver resets and SSID scanning after repeated failures  
- **MQTT Guard** with exponential backoff and session repair  
- Retained-message **flush window** on startup  
- Home Assistant **Discovery publishing** (payload stored in PROGMEM)  

---

## 6. HardwareInit — Low-Level Startup

- Prints structured firmware banner at boot  
- Configures ESP-IDF task watchdog (**IDF4** / **IDF5** compatible)  
- Provides safe periodic resets via `watchdogKick()`  

---

## 7. HestiaTools — Utilities

- Named timers: **one-shot**, **running**, **cancel**, and **rearmable**  
- ISO-8601 timestamp generation (millisecond precision)  
- Compact JSON log builder for HA or console storage  

---

## 8. Directory Structure

HestiaSDK/
│
├── src/
│   ├── HestiaCore.cpp / .h
│   ├── HAIotBridge.cpp / .h
│   ├── HestiaConfig.cpp / .h
│   ├── HestiaParam.cpp / .h
│   ├── HestiaNetSDK.cpp / .h
│   ├── HestiaProvisioning.cpp / .h
│   ├── HardwareInit.cpp / .h
│   └── HestiaTools.cpp / .h
│
├── DeviceParams.h          ← PROGMEM schema
├── main.h                  ← bridge_config[], HA Discovery JSON
└── library.properties

## Dependencies

Uses only standard ESP32 Arduino Core components:

- WiFi
- MQTTClient
- ArduinoJson
- Preferences / NVS
- ESP-IDF watchdog API (via Arduino core)

No third-party libraries required.

---

## Compatibility

| Platform        | Status               |
|-----------------|----------------------|
| ESP32-C3        | ✔ stable             |
| ESP32-C6        | ✔ stable             |
| ESP32-S3        | ✔ stable             |
| ESP32 classic   | partial, not prioritized |

---

## Design Notes

- All networking and runtime flows are non-blocking  
- Provisioning is fully blocking by design  
- Entity management is deterministic, no dynamic allocation at runtime  
- Configuration model:  
  `metadata → instance → NVS → runtime validation`

---

## License

MIT.
